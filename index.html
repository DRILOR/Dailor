<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Videollamada TerapÃ©utica Inmersiva</title>
  <style>
    :root {
      --primario: #7f00ff;
      --secundario: #e100ff;
      --acento: #ff5722;
      --fondo: linear-gradient(to right, #7f00ff, #e100ff);
      --blanco: #ffffff;
      --gris-fondo: #f0f0f5;
      --gris-claro: #ddd;
      --texto: #222;
      --fuente: 'Segoe UI', sans-serif;
    }

    body {
      margin: 0;
      font-family: var(--fuente);
      background: var(--gris-fondo);
      color: var(--texto);
    }

    header {
      background: var(--fondo);
      color: var(--blanco);
      text-align: center;
      padding: 30px 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    header h1 {
      margin: 0;
      font-size: 2.2em;
      letter-spacing: 1px;
    }

    .contenedor {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .videos {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-bottom: 30px;
    }

    video {
      flex: 1;
      min-width: 300px;
      max-width: 48%;
      border: 4px solid var(--primario);
      border-radius: 14px;
      background: #000;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
    }

    .controles, .herramientas {
      text-align: center;
      margin-bottom: 25px;
    }

    .controles button,
    .herramientas button {
      background: var(--acento);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 10px 20px;
      margin: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .controles button:hover,
    .herramientas button:hover {
      background: #ff784e;
      transform: scale(1.05);
    }

    canvas {
      display: block;
      margin: 0 auto 20px;
      background: #fff;
      border: 3px solid var(--primario);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      cursor: crosshair;
    }

    .herramientas input,
    .herramientas select {
      margin: 0 10px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .textareas {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-bottom: 40px;
    }

    .textareas textarea {
      flex: 1;
      min-width: 300px;
      height: 110px;
      border: 2px solid var(--secundario);
      border-radius: 10px;
      padding: 12px;
      font-family: monospace;
      font-size: 14px;
      background: #fff;
      box-shadow: inset 0 1px 4px rgba(0,0,0,0.05);
      resize: vertical;
    }

    @media (max-width: 768px) {
      video, textarea {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>SesiÃ³n Remota Inmersiva</h1>
  </header>

  <div class="contenedor">
    <div class="videos">
      <video id="localVideo" autoplay muted></video>
      <video id="remoteVideo" autoplay></video>
    </div>

    <div class="controles">
      <button onclick="crearOferta()">Crear Oferta</button>
      <button onclick="crearRespuesta()">Crear Respuesta</button>
      <button onclick="agregarRespuesta()">Agregar Respuesta</button>
      <button onclick="compartirPantalla()">Compartir Pantalla</button>
      <button onclick="activarPantallaCompleta()">Pantalla Completa</button>
    </div>

    <div class="herramientas">
      <label>ðŸŽ¨ Color:</label>
      <input type="color" id="colorPincel" value="#000000">
      <label>ðŸ–Œ Grosor:</label>
      <input type="number" id="grosorPincel" value="2" min="1" max="20">
      <button onclick="activarBorrador()">ðŸ§½ Borrador</button>
      <button onclick="activarTexto()">ðŸ”¤ Texto</button>
    </div>

    <canvas id="canvas" width="900" height="450"></canvas>

    <div class="textareas">
      <textarea id="oferta" placeholder="Oferta SDP"></textarea>
      <textarea id="respuesta" placeholder="Respuesta SDP"></textarea>
    </div>
  </div>

  <script>
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const ofertaTextarea = document.getElementById('oferta');
    const respuestaTextarea = document.getElementById('respuesta');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const colorPicker = document.getElementById('colorPincel');
    const grosorInput = document.getElementById('grosorPincel');

    let dibujando = false;
    let usandoTexto = false;
    let modoBorrador = false;
    let ultimaPosicion = { x: 0, y: 0 };

    let localStream;
    let peerConnection;
    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      localStream = stream;
      localVideo.srcObject = stream;
    });

    canvas.addEventListener('mousedown', e => {
      if (usandoTexto) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const texto = prompt("Ingrese el texto:");
        if (texto) {
          ctx.font = "16px sans-serif";
          ctx.fillStyle = colorPicker.value;
          ctx.fillText(texto, x, y);
        }
        return;
      }

      dibujando = true;
      const rect = canvas.getBoundingClientRect();
      ultimaPosicion.x = e.clientX - rect.left;
      ultimaPosicion.y = e.clientY - rect.top;
    });

    canvas.addEventListener('mouseup', () => dibujando = false);

    canvas.addEventListener('mousemove', e => {
      if (!dibujando || usandoTexto) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      ctx.beginPath();
      ctx.moveTo(ultimaPosicion.x, ultimaPosicion.y);
      ctx.lineTo(x, y);
      ctx.strokeStyle = modoBorrador ? '#ffffff' : colorPicker.value;
      ctx.lineWidth = grosorInput.value;
      ctx.lineCap = "round";
      ctx.stroke();

      ultimaPosicion.x = x;
      ultimaPosicion.y = y;
    });

    function activarTexto() {
      usandoTexto = true;
      modoBorrador = false;
    }

    function activarBorrador() {
      modoBorrador = true;
      usandoTexto = false;
    }

    function crearOferta() {
      peerConnection = new RTCPeerConnection(config);
      agregarHandlers();
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
      peerConnection.createOffer().then(offer => {
        peerConnection.setLocalDescription(offer);
        ofertaTextarea.value = JSON.stringify(offer);
      });
    }

    function crearRespuesta() {
      const offer = JSON.parse(ofertaTextarea.value);
      peerConnection = new RTCPeerConnection(config);
      agregarHandlers();
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
      peerConnection.setRemoteDescription(offer).then(() => {
        return peerConnection.createAnswer();
      }).then(answer => {
        peerConnection.setLocalDescription(answer);
        respuestaTextarea.value = JSON.stringify(answer);
      });
    }

    function agregarRespuesta() {
      const answer = JSON.parse(respuestaTextarea.value);
      peerConnection.setRemoteDescription(answer);
    }

    function agregarHandlers() {
      peerConnection.ontrack = e => {
        remoteVideo.srcObject = e.streams[0];
      };
      peerConnection.onicecandidate = e => {
        if (e.candidate) {
          console.log('Nuevo candidato ICE:', JSON.stringify(e.candidate));
        }
      };
    }

    function compartirPantalla() {
      navigator.mediaDevices.getDisplayMedia({ video: true }).then(pantallaStream => {
        const pantallaTrack = pantallaStream.getVideoTracks()[0];
        const sender = peerConnection.getSenders().find(s => s.track.kind === 'video');
        if (sender) sender.replaceTrack(pantallaTrack);
        localVideo.srcObject = pantallaStream;
        pantallaTrack.onended = () => {
          sender.replaceTrack(localStream.getVideoTracks()[0]);
          localVideo.srcObject = localStream;
        };
      }).catch(err => {
        alert('No se pudo compartir la pantalla: ' + err);
      });
    }

    function activarPantallaCompleta() {
      const elemento = document.documentElement;
      if (elemento.requestFullscreen) {
        elemento.requestFullscreen();
      } else if (elemento.webkitRequestFullscreen) {
        elemento.webkitRequestFullscreen();
      } else if (elemento.msRequestFullscreen) {
        elemento.msRequestFullscreen();
      }
    }
  </script>
</body>
</html>
</script>

</body>
</html>
