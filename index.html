<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Videollamada Terapéutica Inmersiva</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
    video { width: 45%; margin: 10px; border: 2px solid #444; }
    canvas { border: 2px solid #222; margin-top: 20px; background: white; cursor: crosshair; }
    textarea { width: 90%; height: 80px; margin-top: 10px; }
    button { margin: 5px; padding: 10px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>Sesión Remota Inmersiva</h1>

  <div>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>

  <div>
    <button onclick="crearOferta()">Crear Oferta</button>
    <button onclick="crearRespuesta()">Crear Respuesta</button>
    <button onclick="agregarRespuesta()">Agregar Respuesta</button>
    <button onclick="compartirPantalla()">Compartir Pantalla</button>
    <button onclick="activarPantallaCompleta()">Pantalla Completa</button>
  </div>

  <div>
    <textarea id="oferta"></textarea>
    <textarea id="respuesta"></textarea>
  </div>

  <canvas id="canvas" width="800" height="400"></canvas>

  <script>
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const ofertaTextarea = document.getElementById('oferta');
    const respuestaTextarea = document.getElementById('respuesta');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let dibujando = false;

    let localStream;
    let peerConnection;
    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      localStream = stream;
      localVideo.srcObject = stream;
    });

    canvas.addEventListener('mousedown', () => dibujando = true);
    canvas.addEventListener('mouseup', () => dibujando = false);
    canvas.addEventListener('mousemove', e => {
      if (!dibujando) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      ctx.fillStyle = '#000';
      ctx.fillRect(x, y, 2, 2);
    });

    function crearOferta() {
      peerConnection = new RTCPeerConnection(config);
      agregarHandlers();
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      peerConnection.createOffer().then(offer => {
        peerConnection.setLocalDescription(offer);
        ofertaTextarea.value = JSON.stringify(offer);
      });
    }

    function crearRespuesta() {
      const offer = JSON.parse(ofertaTextarea.value);
      peerConnection = new RTCPeerConnection(config);
      agregarHandlers();
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      peerConnection.setRemoteDescription(offer).then(() => {
        return peerConnection.createAnswer();
      }).then(answer => {
        peerConnection.setLocalDescription(answer);
        respuestaTextarea.value = JSON.stringify(answer);
      });
    }

    function agregarRespuesta() {
      const answer = JSON.parse(respuestaTextarea.value);
      peerConnection.setRemoteDescription(answer);
    }

    function agregarHandlers() {
      peerConnection.ontrack = e => {
        remoteVideo.srcObject = e.streams[0];
      };
      peerConnection.onicecandidate = e => {
        if (e.candidate) {
          console.log('Nuevo candidato ICE:', JSON.stringify(e.candidate));
        }
      };
    }

    function compartirPantalla() {
      navigator.mediaDevices.getDisplayMedia({ video: true }).then(pantallaStream => {
        const pantallaTrack = pantallaStream.getVideoTracks()[0];
        const sender = peerConnection.getSenders().find(s => s.track.kind === 'video');
        if (sender) sender.replaceTrack(pantallaTrack);

        localVideo.srcObject = pantallaStream;

        pantallaTrack.onended = () => {
          sender.replaceTrack(localStream.getVideoTracks()[0]);
          localVideo.srcObject = localStream;
        };
      }).catch(err => {
        alert('No se pudo compartir la pantalla: ' + err);
      });
    }

    function activarPantallaCompleta() {
      const elemento = document.documentElement;
      if (elemento.requestFullscreen) {
        elemento.requestFullscreen();
      } else if (elemento.webkitRequestFullscreen) {
        elemento.webkitRequestFullscreen();
      } else if (elemento.msRequestFullscreen) {
        elemento.msRequestFullscreen();
      }
    }
  </script>
</body>
</html>
    }
  </script>
</body>
</html>
