<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Terapia Remota Interactiva</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      text-align: center;
    }
    video {
      width: 45%;
      border: 2px solid #333;
      margin: 10px;
    }
    canvas {
      border: 2px solid #444;
      background: white;
      margin: 10px auto;
      display: block;
    }
    textarea {
      width: 90%;
      height: 120px;
      margin: 10px 0;
      font-family: monospace;
    }
    button {
      margin: 5px;
      padding: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>

  <h1>Terapia Remota Interactiva</h1>

  <div>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>

  <canvas id="canvas" width="600" height="300"></canvas>

  <textarea id="signalingBox" placeholder="Aquí se genera o pega la oferta/respuesta JSON"></textarea>

  <div>
    <button onclick="crearOferta()">Crear Oferta</button>
    <button onclick="crearRespuesta()">Crear Respuesta</button>
    <button onclick="agregarRespuesta()">Agregar Respuesta</button>
  </div>

  <div>
    <button onclick="compartirPantalla()">Compartir Pantalla</button>
    <button onclick="activarPantallaCompleta()">Pantalla Completa</button>
  </div>

  <script>
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const signalingBox = document.getElementById("signalingBox");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    let localStream;
    let peerConnection;
    let dataChannel;

    const config = {
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      localStream = stream;
      localVideo.srcObject = stream;
    }).catch(err => alert("Error accediendo a cámara/micrófono: " + err));

    canvas.addEventListener("mousedown", e => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      drawCircle(x, y, "blue");
      if (dataChannel && dataChannel.readyState === "open") {
        dataChannel.send(JSON.stringify({ x, y }));
      }
    });

    function drawCircle(x, y, color) {
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.arc(x, y, 8, 0, 2 * Math.PI);
      ctx.fill();
    }

    function crearConexion() {
      peerConnection = new RTCPeerConnection(config);

      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });

      peerConnection.ontrack = e => {
        remoteVideo.srcObject = e.streams[0];
      };

      peerConnection.onicecandidate = e => {
        if (e.candidate === null) {
          signalingBox.value = JSON.stringify(peerConnection.localDescription);
        }
      };

      peerConnection.ondatachannel = event => {
        dataChannel = event.channel;
        configurarCanal();
      };
    }

    function configurarCanal() {
      dataChannel.onmessage = e => {
        const { x, y } = JSON.parse(e.data);
        drawCircle(x, y, "red");
      };
    }

    function crearOferta() {
      crearConexion();
      dataChannel = peerConnection.createDataChannel("canvas");
      configurarCanal();

      peerConnection.createOffer()
        .then(offer => peerConnection.setLocalDescription(offer));
    }

    function crearRespuesta() {
      const oferta = JSON.parse(signalingBox.value);
      crearConexion();

      peerConnection.setRemoteDescription(new RTCSessionDescription(oferta))
        .then(() => peerConnection.createAnswer())
        .then(answer => peerConnection.setLocalDescription(answer));
    }

    function agregarRespuesta() {
      const respuesta = JSON.parse(signalingBox.value);
      peerConnection.setRemoteDescription(new RTCSessionDescription(respuesta));
    }

    function compartirPantalla() {
      navigator.mediaDevices.getDisplayMedia({ video: true }).then(pantalla => {
        const sender = peerConnection.getSenders().find(s => s.track.kind === "video");
        if (sender) sender.replaceTrack(pantalla.getVideoTracks()[0]);
        localVideo.srcObject = pantalla;

        pantalla.getVideoTracks()[0].onended = () => {
          sender.replaceTrack(localStream.getVideoTracks()[0]);
          localVideo.srcObject = localStream;
        };
      });
    }

    function activarPantallaCompleta() {
      const doc = document.documentElement;
      if (doc.requestFullscreen) {
        doc.requestFullscreen();
      } else if (doc.webkitRequestFullscreen) {
        doc.webkitRequestFullscreen();
      } else if (doc.msRequestFullscreen) {
        doc.msRequestFullscreen();
      }
    }
  </script>
</body>
</html>

    }
  </script>
</body>
</html>
